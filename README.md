```markdown
# Modbus RTU Slave (STM32 + FreeRTOS + HAL)

ุงู ูพุฑูฺู ฺฉ ูพุงุฏูโุณุงุฒ ุณุงุฏู ู ุณุจฺฉ ุงุฒ ูพุฑูุชฺฉู **Modbus RTU Slave** ุจุฑุง ูฺฉุฑูฺฉูุชุฑูุฑูุง STM32 ุงุณุช ฺฉู ููุท ุจุง **ฺฉ ููุฏูุฑ** ู ูุณุฑ **DMA-only** ฺฉุงุฑ ูโฺฉูุฏ.

---

## โจ ูฺฺฏโูุง
- ูุงูฺฉุดูโฺฉุฏูุง ฺฉุงูู: **FC1, FC3, FC5, FC6, FC15, FC16**
- ุฏุฑุงูุช ู ุงุฑุณุงู ููุท ุจุง **DMA** (ReceiveToIdle + Transmit DMA)
- ููุฏูุฑ ูุงุญุฏ (`gModbusH`)
- ุฏุชุงุจุณโูุง ุซุงุจุช ุฏุฑ RAM ุจุฑุง ฺฉููโูุง ู ุฑุฌุณุชุฑูุง
- ฺฉูุชุฑู ุฎูุฏฺฉุงุฑ DE ุจุฑุง RSโ485
- ุดูุงุฑูุฏูโูุง ุฎุทุงุ ูุฑูุฏ ู ุฎุฑูุฌ ุจุฑุง ูุงูุชูุฑูฺฏ

---

## โ๏ธ ุขุฏุฑุณโุฏู PLCโStyle
ุขุฏุฑุณโูุง ุจู ุตูุฑุช ุชุฑฺฉุจ ุงุฒ ุดูุงุฑู ุฏุชุงุจุณ ู ุขูุณุช ุฐุฎุฑู ูโุดููุฏ:

```
raw = db * MB_ADDR_DB_DIVISOR + offset
```

- ููุฏุงุฑ ูพุดโูุฑุถ `MB_ADDR_DB_DIVISOR = 1000`
- ูุซุงูโูุง:
  - `50017` โ DB=50, Coil=17
  - `30005` โ DB=30, Register=5
- ูุญุฏูุฏุช: ุขุฏุฑุณ ุฎุงู ุจุงุฏ โค 65535 ุจุงุดุฏ (ุจู ุฏูู ููุฏ 16โุจุช ุฏุฑ Modbus)

---

## ๐๏ธ ุฏุชุงุจุณโูุง
- **Coils:**  
  - ูุฑ ุฏุชุงุจุณ: `COILS_PER_DB` ุจุช (ูพุดโูุฑุถ 1024)  
  - ุฐุฎุฑูโุณุงุฒ: ุขุฑุงูโ ุจุงุชโูุง
- **Registers:**  
  - ูุฑ ุฏุชุงุจุณ: `REGS_PER_DB` ุฑุฌุณุชุฑ 16โุจุช (ูพุดโูุฑุถ 512)  
  - ุฐุฎุฑูโุณุงุฒ: ุขุฑุงูโ `uint16_t`

---

## ๐ ูุงูฺฉุดูโฺฉุฏูุง
- **FC1 (Read Coils):** ุฎูุงูุฏู ูุถุนุช ฺฉููโูุง  
- **FC3 (Read Holding Registers):** ุฎูุงูุฏู ุฑุฌุณุชุฑูุง  
- **FC5 (Write Single Coil):** ููุดุชู ฺฉ ฺฉูู  
- **FC6 (Write Single Register):** ููุดุชู ฺฉ ุฑุฌุณุชุฑ  
- **FC15 (Write Multiple Coils):** ููุดุชู ฺูุฏ ฺฉูู  
- **FC16 (Write Multiple Registers):** ููุดุชู ฺูุฏ ุฑุฌุณุชุฑ  

ูุฑ ูุงูฺฉุดูโฺฉุฏ ูุจู ุงุฒ ุฏุณุชุฑุณ ุจู ุฏุชุงุจุณ:
- ุขุฏุฑุณ ุฎุงู ุฑุง decode ูโฺฉูุฏ (DB + Offset)
- ูุญุฏูุฏุชโูุง ุฑุง ุจุฑุฑุณ ูโฺฉูุฏ (ุชุนุฏุงุฏุ ูุฑุฒูุงุ ุงูุฏุงุฒู ุจุงูุฑ)
- ุฏุฑ ุตูุฑุช ุฎุทุงุ Exception ูพุงุณุฎ ุฏุงุฏู ูโุดูุฏ

---

## ๐๏ธ ุดูุงุฑูุฏูโูุง
- `u16InCnt` โ ุชุนุฏุงุฏ ูุฑูโูุง ุฏุฑุงูุช ูุนุชุจุฑ  
- `u16OutCnt` โ ุชุนุฏุงุฏ ูพุงุณุฎโูุง ุงุฑุณุงูโุดุฏู  
- `u16errCnt` โ ุชุนุฏุงุฏ ุฎุทุงูุง (CRCุ Overflowุ ุขุฏุฑุณ ูุงูุนุชุจุฑุ ุฎุทุง DMA)

---

## ๐ ุฑุงูโุงูุฏุงุฒ
```c
// ุชุนุฑู ููุฏูุฑ ุณุฑุงุณุฑ
extern modbusHandler_t gModbusH;

// ููุฏุงุฑุฏู
ModbusInit(&huart1, 1, GPIOA, GPIO_PIN_8);

// ุดุฑูุน
ModbusStart();

// ุณุงุฎุช ุชุณฺฉ Slave
osThreadAttr_t attr = { .name="ModbusTask", .priority=osPriorityNormal, .stack_size=512 };
gModbusH.myTaskModbusAHandle = osThreadNew(StartTaskModbusSlave, NULL, &attr);
```

---

## ๐ ุฌุฑุงู ุฏุงุฏู ุฏุฑ Modbus Slave

```text
        โโโโโโโโโโโโโโโโโ
        โ   UART DMA    โ
        โ ReceiveToIdle โ
        โโโโโโโโโฌโโโโโโโโ
                โ
                โผ
        โโโโโโโโโโโโโโโโโโ
        โ  RxEvent ISR   โ
        โ  (HAL Callback)โ
        โโโโโโโโโฌโโโโโโโโโ
                โ Notify
                โผ
        โโโโโโโโโโโโโโโโโโ
        โ Modbus Task    โ
        โ handle_frame() โ
        โโโโโโโโโฌโโโโโโโโโ
                โ
                โ Decode PLC-style address
                โ Check CRC, limits, DB
                โผ
        โโโโโโโโโโโโโโโโโโ
        โ Process FCx    โ
        โ (1,3,5,6,15,16)โ
        โโโโโโโโโฌโโโโโโโโโ
                โ
                โ Build response + CRC
                โผ
        โโโโโโโโโโโโโโโโโโ
        โ UART DMA TX    โ
        โ transmit_response() โ
        โโโโโโโโโฌโโโโโโโโโ
                โ
                โผ
        โโโโโโโโโโโโโโโโโโ
        โ TxCplt ISR     โ
        โ Reset DE,      โ
        โ Notify Task    โ
        โโโโโโโโโโโโโโโโโโ
```

---

## ๐ ุชุณุช ุณุฑุน
- **ุฎูุงูุฏู ุฑุฌุณุชุฑ:**  
  Master โ FC3, Address=30005, Count=2  
  Slave โ DB=30, ุฑุฌุณุชุฑูุง 5 ู 6
- **ููุดุชู ฺฉูู:**  
  Master โ FC5, Address=50017, Value=0xFF00  
  Slave โ DB=50, Coil=17 = ON
- **ููุดุชู ฺูุฏ ุฑุฌุณุชุฑ:**  
  Master โ FC16, Address=10000, Count=4  
  Slave โ DB=10, ุฑุฌุณุชุฑูุง 0..3

---

## โ๏ธ ูฺฉุงุช ููู
- ุขุฏุฑุณ ุฎุงู ุจุงุฏ โค 65535 ุจุงุดุฏ.  
- ุงฺฏุฑ ูุงุฒ ุจู ุฏุชุงุจุณโูุง ุจุฒุฑฺฏโุชุฑ ุฏุงุฑุ ููุฏุงุฑ `MB_ADDR_DB_DIVISOR` ุฑุง ุชุบุฑ ุจุฏู.  
- ุจุฑุง Payloadูุง ุจุฒุฑฺฏ (ูุซูุงู FC16 ุจุง ุชุนุฏุงุฏ ุฒุงุฏ)ุ ูุทูุฆู ุดู `MAX_BUFFER` ฺฉุงู ุงุณุช.  
- ุงุฑุณุงู ู ุฏุฑุงูุช ูุฑ ุฏู ุจุง DMA ุงูุฌุงู ูโุดููุฏุ ูุณุฑ IT ุญุฐู ุดุฏู ุงุณุช.  

---

## ๐๏ธ Troubleshooting

### ุฎุทุง `HAL_BUSY` ุฏุฑ ุงุฑุณุงู
- ุนูุช: ูุฑุงุฎูุงู ููุฒูุงู `HAL_UART_Transmit_DMA` ุฏุฑ ุญุงู ฺฉู ุงุฑุณุงู ูุจู ูููุฒ ุชูุงู ูุดุฏู.  
- ุฑุงูโุญู: ฺฉ ููฺฏ `txInProgress` ุงุถุงูู ฺฉู ู ููุท ููุช ุงุฑุณุงู ูุจู ุชูุงู ุดุฏุ ุงุฑุณุงู ุฌุฏุฏ ุฑุง ุดุฑูุน ฺฉู.

### ุฎุทุง CRC mismatch
- ุนูุช: ููุฒ ุฑู ุฎุท RSโ485 ุง ุชูุธู ุงุดุชุจุงู Baudrate/Parity.  
- ุฑุงูโุญู: Baudrate ู ูพุงุฑุงูุชุฑูุง UART ุฑุง ุจุฑุฑุณ ฺฉูุ ฺฉุงุจู ู ุชุฑููุดู ุฑุง ฺฺฉ ฺฉู.

### Overflow ุฏุฑ ุจุงูุฑ RX
- ุนูุช: ูุฑู ุจุฒุฑฺฏโุชุฑ ุงุฒ `MAX_BUFFER` ุง ุฏุฑุงูุช ุจุฏูู ูพุฑุฏุงุฒุด ุจู ูููุน.  
- ุฑุงูโุญู: ููุฏุงุฑ `MAX_BUFFER` ุฑุง ุงูุฒุงุด ุจุฏู ุง ุชุนุฏุงุฏ ุฑุฌุณุชุฑูุง ุฎูุงูุฏู/ููุดุชู ุดุฏู ุฑุง ูุญุฏูุฏ ฺฉู.

### ูพุงุณุฎ Slave ุงุฑุณุงู ููโุดูุฏ
- ุนูุช: ฺฉูุชุฑู DE ุฏุฑุณุช ุงูุฌุงู ูุดุฏู ุง ูพู EN ุงุดุชุจุงู ุชุนุฑู ุดุฏู.  
- ุฑุงูโุญู: ูุทูุฆู ุดู ูพู EN ุฏุฑุณุช ููุฏุงุฑุฏู ุดุฏู ู ูุจู ุงุฒ ุงุฑุณุงู `SET` ู ุจุนุฏ ุงุฒ TxCplt `RESET` ูโุดูุฏ.
```